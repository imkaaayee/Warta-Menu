<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Warta Menu</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #00c853; --secondary: #ffa000; }
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; margin: 0; }
        .admin-header { background: white; padding: 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .admin-content { max-width: 500px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        .order-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 6px solid var(--secondary); }
        .order-card.selesai { border-left-color: var(--primary); opacity: 0.8; }
        .badge-status { font-size: 11px; padding: 5px 12px; border-radius: 20px; font-weight: bold; }
        .bg-masuk { background: #fff3e0; color: #ef6c00; }
        .bg-selesai { background: #e8f5e9; color: #2e7d32; }
        .item-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .btn-action { border-radius: 12px; font-weight: bold; padding: 12px; margin-top: 15px; width: 100%; border: none; }
        .btn-done { background: var(--primary); color: white; }
        .btn-del { background: #ffebee; color: #c62828; margin-top: 10px; }
    </style>
</head>
<body>

<div class="admin-header">
    <div class="container max-width-500 d-flex justify-content-between align-items-center" style="max-width: 460px; margin: 0 auto;">
        <h4 class="fw-bold m-0">Pesanan Masuk</h4>
        <span id="order-count" class="badge bg-success rounded-pill px-3 py-2">0</span>
    </div>
</div>

<div class="admin-content">
    <div id="admin-order-list">
        <div class="text-center text-muted py-5">Menghubungkan ke server...</div>
    </div>
</div>

<audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyAivSWrd8k-7lRDiqkyzauvcas7pndxhg",
      authDomain: "warta-menu-e8351.firebaseapp.com",
      databaseURL: "https://warta-menu-e8351-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "warta-menu-e8351",
      storageBucket: "warta-menu-e8351.firebasestorage.app",
      messagingSenderId: "661469070998",
      appId: "1:661469070998:web:618c7b8852094a8b52e4b7",
      measurementId: "G-BX79RL4FGX"
    };

    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    // Variabel untuk melacak jumlah pesanan sebelumnya
    let lastOrderCount = 0;

    // Fungsi Utama: Mendengarkan Perubahan Data
    db.ref('pesanan').on('value', (snapshot) => {
        const list = document.getElementById('admin-order-list');
        const count = document.getElementById('order-count');
        const data = snapshot.val();

        if (!data) {
            list.innerHTML = '<div class="text-center text-muted py-5">Belum ada pesanan masuk.</div>';
            count.innerText = "0";
            lastOrderCount = 0;
            return;
        }

        const keys = Object.keys(data).reverse();
        const currentCount = keys.length;
        count.innerText = currentCount;

        // --- LOGIKA SUARA NOTIFIKASI ---
        // Suara hanya bunyi JIKA jumlah pesanan bertambah (ada pesanan baru masuk)
        if (currentCount > lastOrderCount) {
            const sound = document.getElementById('notif-sound');
            if (sound) {
                sound.currentTime = 0; // Reset suara ke awal
                sound.play().catch(err => {
                    console.log("Browser memblokir suara. Silakan klik layar sekali untuk mengaktifkan izin suara.");
                });
            }
        }
        // Update jumlah pesanan terakhir
        lastOrderCount = currentCount;

        // --- TAMPILAN LIST PESANAN (TIDAK BERUBAH) ---
        list.innerHTML = keys.map(key => {
            const ord = data[key];
            const isDone = ord.status === 'Selesai';
            const itemsHtml = (ord.items || []).map(it => {
                const toppingList = (it.tops || []).join(', ') || 'Polos';
                return `
                    <div class="item-row d-flex justify-content-between mb-1">
                        <span>${it.name} <br><small class="text-muted">${toppingList}</small></span>
                        <span class="fw-bold">Rp ${(it.total || 0).toLocaleString()}</span>
                    </div>`;
            }).join('');

            return `
                <div class="order-card" style="background:white; border-radius:20px; padding:15px; margin-bottom:15px; border-left: 6px solid ${isDone ? '#00c853' : '#ffa000'}; box-shadow: 0 4px 10px rgba(0,0,0,0.05); ${isDone ? 'opacity:0.7;' : ''}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h5 class="fw-bold m-0">${ord.customer || 'Tanpa Nama'}</h5>
                            <small class="text-muted">${ord.waktu || '-'}</small>
                        </div>
                        <span class="badge ${isDone ? 'bg-success' : 'bg-warning'} text-dark">
                            ${(ord.status || 'MASUK').toUpperCase()}
                        </span>
                    </div>
                    <hr>
                    <div class="mb-3">${itemsHtml}</div>
                    <div class="d-flex justify-content-between fw-bold">
                        <span>TOTAL (${ord.payment || 'Cash'})</span>
                        <span class="text-success">Rp ${(ord.total || 0).toLocaleString()}</span>
                    </div>
                    ${!isDone ? `
                        <button class="btn btn-success w-100 mt-3 fw-bold" onclick="updateStatus('${key}', 'Selesai')">SIAP DISAJIKAN</button>
                    ` : `
                        <button class="btn btn-outline-danger w-100 mt-2 border-0 btn-sm" onclick="hapusPesanan('${key}')">Hapus Data</button>
                    `}
                </div>`;
        }).join('');
    });

    function updateStatus(id, stat) { db.ref('pesanan/' + id).update({ status: stat }); }
    function hapusPesanan(id) { if(confirm('Hapus data ini?')) { db.ref('pesanan/' + id).remove(); } }
</script>
</body>
</html>